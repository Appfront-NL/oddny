---
import Layout from '../../../layouts/Layout.astro';
import ContentLongLayout from '../../../components/ContentLongLayout.astro';
import RelatedArticles from '../../../components/widgets/RelatedArticles.astro';
import { client, readItems, getAssetUrl, locales, type Locale, defaultLocale } from '../../../lib/directus';

export async function getStaticPaths() {
  const allNews = await client.request(
    readItems('news', {
      filter: { status: { _eq: 'published' } },
      fields: ['slug']
    })
  ) as any[];

  const paths: any[] = [];
  for (const locale of locales) {
    for (const item of allNews) {
      if (item.slug) {
        paths.push({ params: { locale, slug: item.slug } });
      }
    }
  }
  return paths;
}

const { locale, slug } = Astro.params;
const currentLocale = (locales.includes(locale as Locale) ? locale : defaultLocale) as Locale;

const newsItems = await client.request(
  readItems('news', {
    filter: { 
      slug: { _eq: slug },
      status: { _eq: 'published' }
    },
    fields: ['*'],
    limit: 1
  })
) as any[];

const news = newsItems[0];

if (!news) {
  return Astro.redirect('/404');
}

const getLocalizedField = (item: any, field: string) => {
  return item[`${field}_${currentLocale}`] || item[`${field}_en`] || item[field] || '';
};

const defaultImages = [
  '/images/hero-jumping.png',
  '/images/oddny-bird-pink.png',
  '/images/oddny-benefits.png',
  '/images/card-1.png'
];
const getRandomImage = (id: number) => defaultImages[id % defaultImages.length];

const getImageSrc = (item: any) => {
  if (!item.featured_image) return getRandomImage(item.id);
  if (item.featured_image.startsWith('/')) return item.featured_image;
  return getAssetUrl(item.featured_image);
};

const getImageUrl = (imageId: string | null) => {
  if (!imageId) return null;
  return getAssetUrl(imageId);
};

const title = getLocalizedField(news, 'title');
const intro = getLocalizedField(news, 'intro');
const content = getLocalizedField(news, 'content');
const articleLayout = news.article_layout || 'short';

const relatedNews = await client.request(
  readItems('news', {
    filter: { 
      status: { _eq: 'published' },
      slug: { _neq: slug }
    },
    fields: ['*'],
    sort: ['-published_date'],
    limit: 6
  })
) as any[];

function setAttr(opts: { collection: string; item: any; fields?: string[]; mode?: string }) {
  const parts = [`collection:${opts.collection}`, `item:${opts.item}`];
  if (opts.fields) parts.push(`fields:${opts.fields.join(',')}`);
  if (opts.mode) parts.push(`mode:${opts.mode}`);
  return parts.join(';');
}
---

<Layout title={title} currentLocale={currentLocale} currentSlug={`news/${slug}`}>
  {articleLayout === 'long' ? (
    <ContentLongLayout
      item={news}
      collection="news"
      locale={currentLocale}
      title={title}
      intro={intro}
      content={content}
      getImageUrl={getImageUrl}
      setAttr={setAttr}
      relatedItems={relatedNews}
      relatedPath="news"
      relatedTitle={currentLocale === 'nl' ? 'Gerelateerde Artikelen' : 'Related Articles'}
    />
  ) : (
  <article class="news-article">
    <div class="news-hero">
      <div class="news-hero-image">
        <img src={getImageSrc(news)} alt={title} />
        <div class="news-hero-overlay"></div>
      </div>
      <div class="news-hero-content">
        <span class="news-category">{news.category}</span>
        <h1 class="news-title">{title}</h1>
        <div class="news-meta">
          <span class="news-author">{news.author_name}</span>
          <span class="news-separator">â€¢</span>
          <span class="news-date">
            {news.published_date ? new Date(news.published_date).toLocaleDateString(currentLocale === 'nl' ? 'nl-NL' : 'en-US', { day: 'numeric', month: 'long', year: 'numeric' }) : ''}
          </span>
        </div>
      </div>
    </div>

    <div class="news-body">
      <p class="news-intro">{intro}</p>
      <div class="news-content" set:html={content || `<p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat.</p><p>Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi.</p>`} />
    </div>

    <!-- Author Section - Figma Frame 12 -->
    <div class="news-author-section">
      <div class="author-row-1">
        <div class="share-section">
          <span class="share-label">Share Article:</span>
          <div class="share-buttons">
            <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`} target="_blank" rel="noopener noreferrer" class="share-btn">
              <svg viewBox="0 0 21 20" fill="currentColor"><path d="M10.8 10.82H8.1v8.6h2.7v-8.6zm5.3 0v8.6h2.7v-5.6c0-2-1-3.1-2.7-3.3-.1 0-.2 0-.3 0-1.5.1-2.4 1-2.7 1.4v-1h-2.6v8.6h2.7v-2.7c0-.5 0-1 0-1.4 0-.6 0-1.2.3-1.7.2-.4.7-.7 1.2-.7 1.5 0 1.5 1.3 1.5 1.5v5h0zm-6.7-1.1c.9 0 1.6-.7 1.6-1.6s-.7-1.6-1.6-1.6-1.6.7-1.6 1.6.7 1.6 1.6 1.6z"/></svg>
            </a>
            <a href="https://www.instagram.com/" target="_blank" class="share-btn">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 5.2c-1.5 0-2.8 1.3-2.8 2.8s1.3 2.8 2.8 2.8 2.8-1.3 2.8-2.8-1.3-2.8-2.8-2.8zm0 4.6c-1 0-1.8-.8-1.8-1.8s.8-1.8 1.8-1.8 1.8.8 1.8 1.8-.8 1.8-1.8 1.8zm3.5-4.7c0 .4-.3.7-.7.7s-.7-.3-.7-.7.3-.7.7-.7.7.3.7.7zm2 .7c0-.9-.2-1.7-.6-2.2-.4-.5-1-.8-1.9-.9-.9 0-1.1 0-3.4 0s-2.5 0-3.4 0c-.9 0-1.5.3-1.9.9-.4.5-.6 1.3-.6 2.2 0 .9 0 1.1 0 3.4s0 2.5 0 3.4c0 .9.2 1.7.6 2.2.4.5 1 .8 1.9.9.9 0 1.1 0 3.4 0s2.5 0 3.4 0c.9 0 1.5-.3 1.9-.9.4-.5.6-1.3.6-2.2 0-.9 0-1.1 0-3.4s0-2.5 0-3.4z"/></svg>
            </a>
            <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 11 19" fill="currentColor"><path d="M6.8 11V19H3.1v-8H0V7.8h3.1V6.6c0-4.4 1.8-6.6 5.7-6.6 1.2 0 1.5.2 2.2.3v3.2c-.7-.1-.9-.2-1.7-.2-.9 0-1.4.3-1.8.8-.4.5-.6 1.4-.6 2.6v1.2h4.1l-1.1 3.2H6.8z"/></svg>
            </a>
            <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(title)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 14 13" fill="currentColor"><path d="M4.4 0H0l5.2 7.1L.3 13h2.3l4-4.5 3.3 4.5H14L8.6 5.7l4.6-5.6h-2.3L7.6 4.3 4.4 0z"/></svg>
            </a>
            <a href="https://www.youtube.com/" target="_blank" class="share-btn">
              <svg viewBox="0 0 18 12" fill="currentColor"><path d="M15 0H3C1.3 0 0 1.4 0 3.2v5.7C0 10.6 1.3 12 3 12h12c1.6 0 3-1.4 3-3.2V3.2C18 1.4 16.6 0 15 0zm-3 5.9l-5 2.9V3l5 2.9z"/></svg>
            </a>
            <a href={`https://wa.me/?text=${encodeURIComponent(title + ' ' + Astro.url.href)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 18 18" fill="currentColor"><path d="M9 0C4.6 0 1 3.6 1 8c0 1.4.4 2.8 1 4l-.7 4 4-1.5c1.1.5 2.4.8 3.7.8 4.4 0 8-3.6 8-8s-3.6-8-8-8z"/></svg>
            </a>
          </div>
        </div>
        <a href={`/${currentLocale}/news`} class="all-articles-link">
          All Articles
          <svg width="24" height="12" viewBox="0 0 24 12" fill="none">
            <path d="M18 1L23 6L18 11M0 6H23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>

      <div class="author-row-2">
        <div class="author-info">
          <div class="author-card">
            <span class="author-name">{news.author_name || 'Ina Sok'}</span>
            <span class="author-role">{news.author_role || 'Artist'}</span>
          </div>
          <p class="author-description">
            Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh
          </p>
        </div>
        <div class="community-cta">
          <div class="cta-bubble">
            <span>"Join our community today"</span>
          </div>
          <img src="/images/oddny-jumping-partner.png" alt="Oddny" class="cta-bird" />
        </div>
      </div>
    </div>

    {relatedNews.length > 0 && (
      <RelatedArticles articles={relatedNews.map((item: any) => ({ ...item, collection: 'news' }))} locale={currentLocale} limit={6} />
    )}
  </article>
  )}
</Layout>

<style>
  .news-article {
    width: 100%;
    font-family: 'Neue Haas Grotesk Display Pro', sans-serif;
  }

  .news-hero {
    position: relative;
    width: 100%;
    height: 70vh;
    min-height: 500px;
    max-height: 700px;
    overflow: hidden;
  }

  .news-hero-image {
    position: absolute;
    inset: 0;
  }

  .news-hero-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .news-hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.1) 100%);
  }

  .news-hero-content {
    position: absolute;
    bottom: 60px;
    left: 0;
    right: 0;
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding);
    color: white;
  }

  .news-category {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #00FC26;
    margin-bottom: 16px;
  }

  .news-title {
    font-size: 52px;
    font-weight: 500;
    color: white;
    margin: 0 0 20px 0;
    line-height: 1.1;
    max-width: 800px;
  }

  .news-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: rgba(255,255,255,0.8);
  }

  .news-author {
    font-weight: 500;
    color: white;
  }

  .news-separator {
    opacity: 0.5;
  }

  .news-body {
    max-width: 800px;
    margin: 0 auto;
    padding: 60px var(--content-padding);
  }

  .news-intro {
    font-size: 22px;
    font-weight: 400;
    color: #42383e;
    margin: 0 0 40px 0;
    line-height: 1.6;
    padding-bottom: 40px;
    border-bottom: 1px solid #eee;
  }

  .news-content {
    font-size: 18px;
    line-height: 1.8;
    color: #42383e;
  }

  .news-content :global(p) {
    margin: 0 0 24px 0;
  }

  .news-content :global(h2) {
    font-size: 28px;
    font-weight: 500;
    margin: 48px 0 24px 0;
    color: #42383e;
  }

  .news-content :global(h3) {
    font-size: 22px;
    font-weight: 500;
    margin: 36px 0 16px 0;
    color: #42383e;
  }

  .news-content :global(ul), .news-content :global(ol) {
    margin: 0 0 24px 0;
    padding-left: 24px;
  }

  .news-content :global(li) {
    margin-bottom: 8px;
  }

  .news-content :global(blockquote) {
    margin: 32px 0;
    padding: 24px 32px;
    border-left: 4px solid #ff40b4;
    background: #fafafa;
    font-style: italic;
    color: #666;
  }

  .news-author-section {
    display: flex;
    flex-direction: column;
    gap: 40px;
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 40px var(--content-padding);
  }

  .author-row-1 {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .share-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .share-label {
    font-size: 22px;
    font-weight: 500;
    color: #42383e;
  }

  .share-buttons {
    display: flex;
    gap: 8px;
  }

  .share-btn {
    width: 28px;
    height: 28px;
    background: #ff40b4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
  }

  .share-btn svg {
    width: 14px;
    height: 14px;
  }

  .share-btn:hover {
    opacity: 0.8;
  }

  .all-articles-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #ff40b4;
    text-decoration: none;
    font-size: 18px;
    font-weight: 600;
  }

  .all-articles-link:hover {
    opacity: 0.8;
  }

  .author-row-2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .author-card {
    background: #ff40b4;
    border-radius: 8px;
    padding: 16px 25px;
    display: flex;
    flex-direction: column;
    color: white;
    min-width: 160px;
  }

  .author-name {
    font-size: 22px;
    font-weight: 500;
    line-height: 22px;
  }

  .author-role {
    font-size: 16px;
    line-height: 22px;
  }

  .author-description {
    font-size: 22px;
    font-weight: 300;
    line-height: 30px;
    color: #888484;
    max-width: 405px;
    margin: 0;
  }

  .community-cta {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cta-bubble {
    background: #d9d9d9;
    border-radius: 4px;
    padding: 10px 20px;
    position: relative;
  }

  .cta-bubble::after {
    content: '';
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-left-color: #d9d9d9;
  }

  .cta-bubble span {
    font-size: 16px;
    font-weight: 500;
    color: #42383e;
  }

  .cta-bird {
    width: 232px;
    height: 223px;
    object-fit: contain;
  }

  @media (max-width: 768px) {
    .news-hero {
      height: 60vh;
      min-height: 400px;
    }

    .news-hero-content {
      bottom: 40px;
    }

    .news-title {
      font-size: 32px;
    }

    .news-body {
      padding: 40px var(--content-padding);
    }

    .news-intro {
      font-size: 18px;
      margin-bottom: 30px;
      padding-bottom: 30px;
    }

    .news-content {
      font-size: 16px;
    }
  }
</style>
