---
import Layout from '../../../layouts/Layout.astro';
import RelatedArticles from '../../../components/widgets/RelatedArticles.astro';
import { getGuideBySlug, getSimilarGuides, getGuides, locales, type Locale, defaultLocale, PUBLIC_DIRECTUS_URL } from '../../../lib/directus';

export async function getStaticPaths() {
  return [];
}

const { locale, slug } = Astro.params;
const currentLocale = (locales.includes(locale as Locale) ? locale : defaultLocale) as Locale;
const guide = await getGuideBySlug(slug as string);

if (!guide) {
  return Astro.redirect('/404');
}

const similarGuides = guide.category ? await getSimilarGuides(guide.category, guide.id, 6) : await getGuides('published');
const directusUrl = PUBLIC_DIRECTUS_URL;

const title = guide[`title_${currentLocale}`] || guide.title_nl || guide.title_en || 'Untitled';
const intro = guide[`intro_${currentLocale}`] || guide.intro_nl || guide.intro_en || '';
const content = guide[`content_${currentLocale}`] || guide.content_nl || guide.content_en || '';

function getImageUrl(imageId: string | null) {
  if (!imageId) return null;
  return `${directusUrl}/assets/${imageId}`;
}

function setAttr(opts: { collection: string; item: any; fields?: string[]; mode?: string }) {
  const parts = [`collection:${opts.collection}`, `item:${opts.item}`];
  if (opts.fields) parts.push(`fields:${opts.fields.join(',')}`);
  if (opts.mode) parts.push(`mode:${opts.mode}`);
  return parts.join(';');
}

const otherLocale = currentLocale === 'nl' ? 'en' : 'nl';
---

<Layout title={title} currentLocale={currentLocale} currentSlug={`guides/${slug}`}>
  <article class="guide-article" data-directus={setAttr({ collection: 'guides', item: guide.id, mode: 'drawer' })}>
    
    <!-- Guide Hero (colored background instead of image) -->
    <section class="guide-hero">
      <div 
        class="guide-bg"
        data-directus={setAttr({ collection: 'guides', item: guide.id, fields: ['category'], mode: 'popover' })}
      >
        <span class="category-label">{guide.category || 'Guide'}</span>
        <h1 
          class="guide-heading"
          data-directus={setAttr({ collection: 'guides', item: guide.id, fields: [`title_${currentLocale}`], mode: 'popover' })}
        >
          {title}
        </h1>
      </div>
    </section>

    <!-- Content Section -->
    <div class="guide-content-wrapper">
      <!-- Left Column: Harrison illustration -->
      <div class="guide-illustration">
        <img src="/images/oddny-jumping-partner.png" alt="Harrison" class="harrison-img" />
      </div>

      <!-- Right Column: Title and Intro -->
      <div class="guide-header">
        <h2 
          class="guide-title"
          data-directus={setAttr({ collection: 'guides', item: guide.id, fields: [`title_${currentLocale}`], mode: 'popover' })}
        >
          {title}
        </h2>
        <p 
          class="guide-intro"
          data-directus={setAttr({ collection: 'guides', item: guide.id, fields: [`intro_${currentLocale}`], mode: 'popover' })}
        >
          {intro}
        </p>
      </div>
    </div>

    <!-- Main Content: Two Columns -->
    <div class="guide-main-content">
      <div 
        class="content-column"
        data-directus={setAttr({ collection: 'guides', item: guide.id, fields: [`content_${currentLocale}`], mode: 'richtext' })}
        set:html={content}
      />
      <div 
        class="content-column"
        data-directus={setAttr({ collection: 'guides', item: guide.id, fields: [`content_${currentLocale}`], mode: 'richtext' })}
        set:html={content}
      />
    </div>

    <!-- Download/Info Buttons -->
    {(guide.more_info_url || guide.download_url) && (
      <div class="guide-actions">
        {guide.more_info_url && (
          <a href={guide.more_info_url} class="guide-btn guide-btn-info" target="_blank" rel="noopener noreferrer">
            More info
            <svg width="24" height="12" viewBox="0 0 24 12" fill="none">
              <path d="M18 1L23 6L18 11M0 6H23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        )}
        {guide.download_url && (
          <a href={guide.download_url} class="guide-btn guide-btn-download" target="_blank" rel="noopener noreferrer">
            Download
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M8 1V11M8 11L4 7M8 11L12 7M1 15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        )}
      </div>
    )}

    <!-- Author Section - Figma Frame 12 -->
    <div class="guide-author-section">
      <div class="author-row-1">
        <div class="share-section">
          <span class="share-label">Share Article:</span>
          <div class="share-buttons">
            <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`} target="_blank" rel="noopener noreferrer" class="share-btn">
              <svg viewBox="0 0 21 20" fill="currentColor"><path d="M10.8 10.82H8.1v8.6h2.7v-8.6zm5.3 0v8.6h2.7v-5.6c0-2-1-3.1-2.7-3.3-.1 0-.2 0-.3 0-1.5.1-2.4 1-2.7 1.4v-1h-2.6v8.6h2.7v-2.7c0-.5 0-1 0-1.4 0-.6 0-1.2.3-1.7.2-.4.7-.7 1.2-.7 1.5 0 1.5 1.3 1.5 1.5v5h0zm-6.7-1.1c.9 0 1.6-.7 1.6-1.6s-.7-1.6-1.6-1.6-1.6.7-1.6 1.6.7 1.6 1.6 1.6z"/></svg>
            </a>
            <a href="https://www.instagram.com/" target="_blank" class="share-btn">
              <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 5.2c-1.5 0-2.8 1.3-2.8 2.8s1.3 2.8 2.8 2.8 2.8-1.3 2.8-2.8-1.3-2.8-2.8-2.8zm0 4.6c-1 0-1.8-.8-1.8-1.8s.8-1.8 1.8-1.8 1.8.8 1.8 1.8-.8 1.8-1.8 1.8zm3.5-4.7c0 .4-.3.7-.7.7s-.7-.3-.7-.7.3-.7.7-.7.7.3.7.7zm2 .7c0-.9-.2-1.7-.6-2.2-.4-.5-1-.8-1.9-.9-.9 0-1.1 0-3.4 0s-2.5 0-3.4 0c-.9 0-1.5.3-1.9.9-.4.5-.6 1.3-.6 2.2 0 .9 0 1.1 0 3.4s0 2.5 0 3.4c0 .9.2 1.7.6 2.2.4.5 1 .8 1.9.9.9 0 1.1 0 3.4 0s2.5 0 3.4 0c.9 0 1.5-.3 1.9-.9.4-.5.6-1.3.6-2.2 0-.9 0-1.1 0-3.4s0-2.5 0-3.4z"/></svg>
            </a>
            <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 11 19" fill="currentColor"><path d="M6.8 11V19H3.1v-8H0V7.8h3.1V6.6c0-4.4 1.8-6.6 5.7-6.6 1.2 0 1.5.2 2.2.3v3.2c-.7-.1-.9-.2-1.7-.2-.9 0-1.4.3-1.8.8-.4.5-.6 1.4-.6 2.6v1.2h4.1l-1.1 3.2H6.8z"/></svg>
            </a>
            <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(title)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 14 13" fill="currentColor"><path d="M4.4 0H0l5.2 7.1L.3 13h2.3l4-4.5 3.3 4.5H14L8.6 5.7l4.6-5.6h-2.3L7.6 4.3 4.4 0z"/></svg>
            </a>
            <a href="https://www.youtube.com/" target="_blank" class="share-btn">
              <svg viewBox="0 0 18 12" fill="currentColor"><path d="M15 0H3C1.3 0 0 1.4 0 3.2v5.7C0 10.6 1.3 12 3 12h12c1.6 0 3-1.4 3-3.2V3.2C18 1.4 16.6 0 15 0zm-3 5.9l-5 2.9V3l5 2.9z"/></svg>
            </a>
            <a href={`https://wa.me/?text=${encodeURIComponent(title + ' ' + Astro.url.href)}`} target="_blank" class="share-btn">
              <svg viewBox="0 0 18 18" fill="currentColor"><path d="M9 0C4.6 0 1 3.6 1 8c0 1.4.4 2.8 1 4l-.7 4 4-1.5c1.1.5 2.4.8 3.7.8 4.4 0 8-3.6 8-8s-3.6-8-8-8z"/></svg>
            </a>
          </div>
        </div>
        <a href={`/${currentLocale}/guides`} class="all-guides-link">
          All Articles
          <svg width="24" height="12" viewBox="0 0 24 12" fill="none">
            <path d="M18 1L23 6L18 11M0 6H23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>

      <div class="author-row-2">
        <div class="author-info">
          <div class="author-card" data-directus={setAttr({ collection: 'guides', item: guide.id, fields: ['author_name', 'author_role'], mode: 'popover' })}>
            <span class="author-name">{guide.author_name || 'Ina Sok'}</span>
            <span class="author-role">{guide.author_role || 'Artist'}</span>
          </div>
          <p class="author-description">
            Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh
          </p>
        </div>
        <div class="community-cta">
          <div class="cta-bubble">
            <span>"Join our community today"</span>
          </div>
          <img src="/images/oddny-jumping-partner.png" alt="Oddny" class="cta-bird" />
        </div>
      </div>
    </div>

    <!-- Related Articles -->
    {similarGuides.length > 0 && (
      <RelatedArticles articles={similarGuides.map((item: any) => ({ ...item, collection: 'guides' }))} locale={currentLocale} limit={6} />
    )}
  </article>
</Layout>

<style>
  .guide-article {
    width: 100%;
    max-width: var(--content-max-width);
    margin: 0 auto;
    background: white;
    font-family: 'Neue Haas Grotesk Display Pro', sans-serif;
  }

  .guide-hero {
    position: relative;
    width: 100%;
    padding: 49px var(--content-padding) 0;
  }

  .guide-bg {
    width: 100%;
    height: 636px;
    border-radius: 10px;
    overflow: hidden;
    background: #00FC26;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .category-label {
    position: absolute;
    top: 30px;
    right: 40px;
    font-weight: 700;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
  }

  .guide-heading {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    width: 550px;
    font-weight: 700;
    font-size: 55px;
    font-style: italic;
    line-height: 60px;
    color: white;
    margin: 0;
  }

  .guide-content-wrapper {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 40px;
    padding: 60px var(--content-padding);
    align-items: start;
  }

  .guide-illustration {
    position: relative;
  }

  .harrison-img {
    width: 220px;
    height: 211px;
    object-fit: contain;
    transform: scaleY(-1) rotate(180deg);
  }

  .guide-header {
    max-width: 612px;
    margin-left: auto;
  }

  .guide-title {
    font-size: 80px;
    font-weight: 500;
    line-height: 85px;
    color: #42383e;
    margin: 0 0 40px;
  }

  .guide-intro {
    font-size: 28px;
    font-weight: 500;
    line-height: 30px;
    color: #888484;
    margin: 0;
  }

  .guide-main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 80px;
    padding: 120px var(--content-padding) 60px;
  }

  .content-column {
    font-size: 22px;
    line-height: 30px;
    color: #888484;
  }

  .content-column :global(p) {
    margin-bottom: 20px;
  }

  .guide-actions {
    display: flex;
    gap: 20px;
    padding: 0 80px 60px;
    justify-content: flex-start;
  }

  .guide-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 32px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .guide-btn-info {
    background: white;
    color: #42383e;
    border: 2px solid #42383e;
  }

  .guide-btn-info:hover {
    background: #42383e;
    color: white;
  }

  .guide-btn-download {
    background: #00FC26;
    color: white;
    border: 2px solid #00FC26;
  }

  .guide-btn-download:hover {
    background: #00d920;
    border-color: #00d920;
  }

  .guide-author-section {
    display: flex;
    flex-direction: column;
    gap: 40px;
    padding: 40px var(--content-padding);
    margin: 0;
  }

  .author-row-1 {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .share-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .share-label {
    font-size: 22px;
    font-weight: 500;
    color: #42383e;
  }

  .share-buttons {
    display: flex;
    gap: 8px;
  }

  .share-btn {
    width: 28px;
    height: 28px;
    background: #00FC26;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
  }

  .share-btn svg {
    width: 14px;
    height: 14px;
  }

  .share-btn:hover {
    opacity: 0.8;
  }

  .all-guides-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #00FC26;
    text-decoration: none;
    font-size: 18px;
    font-weight: 600;
  }

  .all-guides-link:hover {
    opacity: 0.8;
  }

  .author-row-2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .author-card {
    background: #00FC26;
    border-radius: 8px;
    padding: 16px 25px;
    display: flex;
    flex-direction: column;
    color: white;
    min-width: 160px;
  }

  .author-name {
    font-size: 22px;
    font-weight: 500;
    line-height: 26px;
  }

  .author-role {
    font-size: 16px;
    line-height: 22px;
  }

  .author-description {
    font-size: 22px;
    line-height: 30px;
    color: #888484;
    max-width: 405px;
    margin: 0;
  }

  .community-cta {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cta-bubble {
    background: #d9d9d9;
    border-radius: 4px;
    padding: 10px 20px;
    position: relative;
  }

  .cta-bubble::after {
    content: '';
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-left-color: #d9d9d9;
  }

  .cta-bubble span {
    font-size: 16px;
    font-weight: 500;
    color: #42383e;
  }

  .cta-bird {
    width: 150px;
    height: 150px;
    object-fit: contain;
  }

  .similar-guides {
    padding: 60px var(--content-padding);
    background: white;
  }

  .similar-title {
    font-size: 28px;
    font-weight: 500;
    line-height: 24px;
    color: #42383e;
    margin: 0 0 40px;
  }

  .similar-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 40px;
  }

  .similar-card {
    text-decoration: none;
    color: inherit;
  }

  .similar-image {
    width: 100%;
    height: 177px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .similar-card-title {
    font-size: 22px;
    font-weight: 500;
    line-height: 24px;
    color: #42383e;
    margin: 0 0 8px;
  }

  .similar-card-excerpt {
    font-size: 12px;
    line-height: 16px;
    color: #888484;
    margin: 0;
  }

  .similar-card:hover .similar-card-title {
    color: #00FC26;
  }

  @media (max-width: 1200px) {
    .guide-hero {
      padding: 30px 40px 0;
    }
    .guide-bg {
      height: 400px;
    }
    .guide-heading {
      font-size: 40px;
      line-height: 44px;
      width: 400px;
    }
    .guide-content-wrapper {
      padding: 40px;
      grid-template-columns: 1fr;
    }
    .guide-illustration {
      display: none;
    }
    .guide-title {
      font-size: 48px;
      line-height: 52px;
    }
    .guide-main-content {
      grid-template-columns: 1fr;
      padding: 60px 40px;
    }
    .guide-actions {
      padding: 0 40px 40px;
    }
    .guide-author-section {
      padding: 40px;
    }
    .similar-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    .similar-guides {
      padding: 40px;
    }
  }

  @media (max-width: 768px) {
    .guide-hero {
      padding: 20px;
    }
    .guide-bg {
      height: 300px;
    }
    .guide-heading {
      font-size: 28px;
      line-height: 32px;
      width: auto;
      left: 20px;
      right: 20px;
    }
    .category-label {
      font-size: 14px;
      top: 20px;
      right: 20px;
    }
    .guide-content-wrapper {
      padding: 20px;
    }
    .guide-title {
      font-size: 32px;
      line-height: 38px;
    }
    .guide-intro {
      font-size: 18px;
      line-height: 24px;
    }
    .guide-main-content {
      padding: 40px 20px;
    }
    .guide-actions {
      padding: 0 20px 30px;
      flex-direction: column;
    }
    .guide-btn {
      width: 100%;
      justify-content: center;
    }
    .guide-author-section {
      padding: 30px 20px;
    }
    .author-row-1 {
      flex-direction: column;
      gap: 20px;
    }
    .author-row-2 {
      flex-direction: column;
      align-items: flex-start;
      gap: 24px;
    }
    .similar-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .similar-guides {
      padding: 20px;
    }
  }
</style>

<script is:inline>
(function() {
  if (window.self !== window.top) {
    document.documentElement.classList.add('in-visual-editor');
  }
})();
</script>

<style is:global>
  .in-visual-editor [data-directus] {
    position: relative;
    transition: outline 0.15s ease;
  }
  .in-visual-editor [data-directus]:hover {
    outline: 2px solid #6644ff;
    outline-offset: 4px;
    cursor: pointer;
  }
</style>

<script is:inline define:vars={{ directusUrl, guideId: guide.id, currentLocale, otherLocale, slug }}>
(function() {
  var inIframe = window.self !== window.top;
  if (!inIframe) return;

  var DIRECTUS_URL = directusUrl;
  var GUIDE_ID = guideId;
  var CURRENT_LOCALE = currentLocale;
  var accessToken = null;

  async function getAccessToken() {
    if (accessToken) return accessToken;
    
    try {
      var response = await fetch(DIRECTUS_URL + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: 'fabian.vandijk@appfont.nl',
          password: 'admin123'
        })
      });
      
      if (response.ok) {
        var data = await response.json();
        accessToken = data.data.access_token;
        return accessToken;
      }
    } catch(e) {
      console.error('Login failed:', e);
    }
    
    return null;
  }

  document.querySelectorAll('[data-directus]').forEach(function(el) {
    el.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      var attr = el.getAttribute('data-directus');
      var parts = {};
      attr.split(';').forEach(function(part) {
        var kv = part.split(':');
        if (kv.length >= 2) parts[kv[0]] = kv.slice(1).join(':');
      });

      if (parts.mode === 'drawer') {
        window.open(DIRECTUS_URL + '/admin/content/' + parts.collection + '/' + parts.item, '_blank');
        return;
      }

      if (!parts.fields) return;
      var field = parts.fields.split(',')[0];
      
      if (parts.mode === 'richtext') {
        showRichTextEditor(el, parts.collection, parts.item, field);
      } else {
        showEditPopup(el, parts.collection, parts.item, field);
      }
    });
  });

  function loadQuill(callback) {
    if (window.Quill) return callback();
    
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdn.quilljs.com/1.3.7/quill.snow.css';
    document.head.appendChild(link);
    
    var script = document.createElement('script');
    script.src = 'https://cdn.quilljs.com/1.3.7/quill.min.js';
    script.onload = callback;
    document.head.appendChild(script);
  }

  function showRichTextEditor(targetEl, collection, itemId, field) {
    loadQuill(function() {
      var existing = document.querySelector('.richtext-edit-popup');
      if (existing) existing.remove();
      var existingOverlay = document.querySelector('.richtext-overlay');
      if (existingOverlay) existingOverlay.remove();

      var currentValue = targetEl.innerHTML;

      var popup = document.createElement('div');
      popup.className = 'richtext-edit-popup';
      popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:10000;width:80vw;max-width:900px;height:80vh;display:flex;flex-direction:column;font-family:Inter,system-ui,sans-serif;';
      
      popup.innerHTML =
        '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;border-radius:12px 12px 0 0;">' +
          '<h3 style="margin:0;font-size:14px;font-weight:600;color:#374151;">Edit Content</h3>' +
          '<button class="close-btn" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;">&times;</button>' +
        '</div>' +
        '<div id="quill-editor" style="flex:1;overflow-y:auto;"></div>' +
        '<div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #e5e7eb;">' +
          '<button class="cancel-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:white;border:1px solid #d1d5db;color:#374151;">Cancel</button>' +
          '<button class="save-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:#6644ff;border:none;color:white;">Save</button>' +
        '</div>';

      var overlay = document.createElement('div');
      overlay.className = 'richtext-overlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;';
      
      document.body.appendChild(overlay);
      document.body.appendChild(popup);

      var quill = new Quill('#quill-editor', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['blockquote', 'link', 'image'],
            [{ 'align': [] }],
            ['clean']
          ]
        }
      });
      
      quill.root.innerHTML = currentValue;

      function closePopup() {
        popup.remove();
        overlay.remove();
      }

      overlay.onclick = closePopup;
      popup.querySelector('.close-btn').onclick = closePopup;
      popup.querySelector('.cancel-btn').onclick = closePopup;

      popup.querySelector('.save-btn').onclick = async function() {
        var newValue = quill.root.innerHTML;
        var token = await getAccessToken();
        if (!token) {
          alert('No access token - please make sure you are logged into Directus');
          return;
        }
        try {
          var response = await fetch(DIRECTUS_URL + '/items/' + collection + '/' + itemId, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({ [field]: newValue })
          });

          if (response.ok) {
            targetEl.innerHTML = newValue;
            document.querySelectorAll('[data-directus*="' + field + '"]').forEach(function(el) {
              if (el !== targetEl) el.innerHTML = newValue;
            });
            closePopup();
            window.parent.postMessage({ type: 'directus:content-updated' }, '*');
          } else {
            alert('Error saving');
          }
        } catch (err) {
          alert('Error saving: ' + err.message);
        }
      };
    });
  }

  function showEditPopup(targetEl, collection, itemId, field) {
    var existing = document.querySelector('.inline-edit-popup');
    if (existing) existing.remove();

    var currentValue = targetEl.textContent.trim();
    var isTextarea = field.includes('intro') || field.includes('content');

    var popup = document.createElement('div');
    popup.className = 'inline-edit-popup';
    popup.style.cssText = 'position:fixed;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:10000;min-width:320px;max-width:450px;font-family:Inter,system-ui,sans-serif;';
    popup.innerHTML =
      '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;border-radius:12px 12px 0 0;">' +
        '<h3 style="margin:0;font-size:14px;font-weight:600;color:#374151;">Edit ' + field + '</h3>' +
        '<button class="close-btn" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;">&times;</button>' +
      '</div>' +
      '<div style="padding:16px;">' +
        (isTextarea
          ? '<textarea class="edit-input" style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;min-height:150px;resize:vertical;">' + currentValue + '</textarea>'
          : '<input type="text" class="edit-input" value="' + currentValue.replace(/"/g, '&quot;') + '" style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">') +
      '</div>' +
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #e5e7eb;">' +
        '<button class="cancel-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:white;border:1px solid #d1d5db;color:#374151;">Cancel</button>' +
        '<button class="save-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:#6644ff;border:none;color:white;">Save</button>' +
      '</div>';

    var rect = targetEl.getBoundingClientRect();
    popup.style.top = Math.min(rect.bottom + 10, window.innerHeight - 300) + 'px';
    popup.style.left = Math.max(10, Math.min(rect.left, window.innerWidth - 350)) + 'px';

    document.body.appendChild(popup);

    var input = popup.querySelector('.edit-input');
    input.focus();

    popup.querySelector('.close-btn').onclick = function() { popup.remove(); };
    popup.querySelector('.cancel-btn').onclick = function() { popup.remove(); };

    popup.querySelector('.save-btn').onclick = async function() {
      var newValue = input.value;
      var token = await getAccessToken();
      if (!token) {
        alert('No access token - please make sure you are logged into Directus');
        return;
      }
      try {
        var response = await fetch(DIRECTUS_URL + '/items/' + collection + '/' + itemId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ [field]: newValue })
        });

        if (response.ok) {
          if (targetEl.innerHTML !== undefined && isTextarea) {
            targetEl.innerHTML = newValue;
          } else {
            targetEl.textContent = newValue;
          }
          popup.remove();
          window.parent.postMessage({ type: 'directus:content-updated' }, '*');
        } else {
          alert('Error saving');
        }
      } catch (err) {
        alert('Error saving');
      }
    };
  }
})();
</script>
