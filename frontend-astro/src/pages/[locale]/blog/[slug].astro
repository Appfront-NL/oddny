---
import Layout from '../../../layouts/Layout.astro';
import { getBlogBySlug, getSimilarBlogs, getBlogs, locales, type Locale, defaultLocale, PUBLIC_DIRECTUS_URL } from '../../../lib/directus';

export async function getStaticPaths() {
  return [];
}

const { locale, slug } = Astro.params;
const currentLocale = (locales.includes(locale as Locale) ? locale : defaultLocale) as Locale;
const blog = await getBlogBySlug(slug as string);

if (!blog) {
  return Astro.redirect('/404');
}

const similarBlogs = blog.category ? await getSimilarBlogs(blog.category, blog.id, 6) : await getBlogs('published');
const directusUrl = PUBLIC_DIRECTUS_URL;

const title = blog[`title_${currentLocale}`] || blog.title_nl || blog.title_en || 'Untitled';
const intro = blog[`intro_${currentLocale}`] || blog.intro_nl || blog.intro_en || '';
const content = blog[`content_${currentLocale}`] || blog.content_nl || blog.content_en || '';

function getImageUrl(imageId: string | null) {
  if (!imageId) return null;
  return `${directusUrl}/assets/${imageId}`;
}

function setAttr(opts: { collection: string; item: any; fields?: string[]; mode?: string }) {
  const parts = [`collection:${opts.collection}`, `item:${opts.item}`];
  if (opts.fields) parts.push(`fields:${opts.fields.join(',')}`);
  if (opts.mode) parts.push(`mode:${opts.mode}`);
  return parts.join(';');
}

const otherLocale = currentLocale === 'nl' ? 'en' : 'nl';
---

<Layout title={title} currentLocale={currentLocale} currentSlug={`blog/${slug}`}>
  <article class="blog-article" data-directus={setAttr({ collection: 'blogs', item: blog.id, mode: 'drawer' })}>
    
    <!-- Hero Image -->
    <div class="blog-hero">
      {getImageUrl(blog.featured_image) ? (
        <img 
          src={getImageUrl(blog.featured_image)} 
          alt={title}
          data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: ['featured_image'], mode: 'popover' })}
        />
      ) : (
        <div class="blog-hero-placeholder"></div>
      )}
    </div>

    <!-- Content Section -->
    <div class="blog-content-wrapper">
      <!-- Left Column: Harrison illustration -->
      <div class="blog-illustration">
        <img src="/images/oddny-jumping-partner.png" alt="Harrison" class="harrison-img" />
      </div>

      <!-- Right Column: Title and Intro -->
      <div class="blog-header">
        <h1 
          class="blog-title"
          data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: [`title_${currentLocale}`], mode: 'popover' })}
        >
          {title}
        </h1>
        <p 
          class="blog-intro"
          data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: [`intro_${currentLocale}`], mode: 'popover' })}
        >
          {intro}
        </p>
      </div>
    </div>

    <!-- Main Content: Two Columns -->
    <div class="blog-main-content">
      <div 
        class="content-column"
        data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: [`content_${currentLocale}`], mode: 'drawer' })}
        set:html={content}
      />
      <div 
        class="content-column"
        data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: [`content_${currentLocale}`], mode: 'drawer' })}
        set:html={content}
      />
    </div>

    <!-- Author Section with Share (Footer) -->
    <div class="blog-author-section">
      <!-- Row 1: Share + All News -->
      <div class="author-row-1">
        {blog.show_social_share && (
          <div class="share-section">
            <span class="share-label">Share News:</span>
            <div class="share-buttons">
              <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(Astro.url.href)}`} target="_blank" rel="noopener noreferrer" class="share-btn">
                <svg viewBox="0 0 21 20" fill="currentColor"><path d="M10.8 10.82H8.1v8.6h2.7v-8.6zm5.3 0v8.6h2.7v-5.6c0-2-1-3.1-2.7-3.3-.1 0-.2 0-.3 0-1.5.1-2.4 1-2.7 1.4v-1h-2.6v8.6h2.7v-2.7c0-.5 0-1 0-1.4 0-.6 0-1.2.3-1.7.2-.4.7-.7 1.2-.7 1.5 0 1.5 1.3 1.5 1.5v5h0zm-6.7-1.1c.9 0 1.6-.7 1.6-1.6s-.7-1.6-1.6-1.6-1.6.7-1.6 1.6.7 1.6 1.6 1.6z"/></svg>
              </a>
              <a href={`https://www.instagram.com/`} target="_blank" class="share-btn">
                <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 5.2c-1.5 0-2.8 1.3-2.8 2.8s1.3 2.8 2.8 2.8 2.8-1.3 2.8-2.8-1.3-2.8-2.8-2.8zm0 4.6c-1 0-1.8-.8-1.8-1.8s.8-1.8 1.8-1.8 1.8.8 1.8 1.8-.8 1.8-1.8 1.8zm3.5-4.7c0 .4-.3.7-.7.7s-.7-.3-.7-.7.3-.7.7-.7.7.3.7.7zm2 .7c0-.9-.2-1.7-.6-2.2-.4-.5-1-.8-1.9-.9-.9 0-1.1 0-3.4 0s-2.5 0-3.4 0c-.9 0-1.5.3-1.9.9-.4.5-.6 1.3-.6 2.2 0 .9 0 1.1 0 3.4s0 2.5 0 3.4c0 .9.2 1.7.6 2.2.4.5 1 .8 1.9.9.9 0 1.1 0 3.4 0s2.5 0 3.4 0c.9 0 1.5-.3 1.9-.9.4-.5.6-1.3.6-2.2 0-.9 0-1.1 0-3.4s0-2.5 0-3.4z"/></svg>
              </a>
              <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} target="_blank" class="share-btn">
                <svg viewBox="0 0 11 19" fill="currentColor"><path d="M6.8 11V19H3.1v-8H0V7.8h3.1V6.6c0-4.4 1.8-6.6 5.7-6.6 1.2 0 1.5.2 2.2.3v3.2c-.7-.1-.9-.2-1.7-.2-.9 0-1.4.3-1.8.8-.4.5-.6 1.4-.6 2.6v1.2h4.1l-1.1 3.2H6.8z"/></svg>
              </a>
              <a href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.href)}&text=${encodeURIComponent(title)}`} target="_blank" class="share-btn">
                <svg viewBox="0 0 14 13" fill="currentColor"><path d="M4.4 0H0l5.2 7.1L.3 13h2.3l4-4.5 3.3 4.5H14L8.6 5.7l4.6-5.6h-2.3L7.6 4.3 4.4 0z"/></svg>
              </a>
              <a href={`https://www.youtube.com/`} target="_blank" class="share-btn">
                <svg viewBox="0 0 18 12" fill="currentColor"><path d="M15 0H3C1.3 0 0 1.4 0 3.2v5.7C0 10.6 1.3 12 3 12h12c1.6 0 3-1.4 3-3.2V3.2C18 1.4 16.6 0 15 0zm-3 5.9l-5 2.9V3l5 2.9z"/></svg>
              </a>
              <a href={`https://wa.me/?text=${encodeURIComponent(title + ' ' + Astro.url.href)}`} target="_blank" class="share-btn">
                <svg viewBox="0 0 18 18" fill="currentColor"><path d="M9 0C4.6 0 1 3.6 1 8c0 1.4.4 2.8 1 4l-.7 4 4-1.5c1.1.5 2.4.8 3.7.8 4.4 0 8-3.6 8-8s-3.6-8-8-8z"/></svg>
              </a>
            </div>
          </div>
        )}
        <a href={`/${currentLocale}/blog`} class="all-articles-link">
          All News
          <svg width="24" height="12" viewBox="0 0 24 12" fill="none">
            <path d="M18 1L23 6L18 11M0 6H23" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>

      <!-- Row 2: Author + CTA -->
      <div class="author-row-2">
        <div class="author-info">
          <div class="author-card" data-directus={setAttr({ collection: 'blogs', item: blog.id, fields: ['author_name', 'author_role'], mode: 'popover' })}>
            <span class="author-name">{blog.author_name || 'Ina Sok'}</span>
            <span class="author-role">{blog.author_role || 'Artist'}</span>
          </div>
          <p class="author-description">
            Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh
          </p>
        </div>
        <div class="community-cta">
          <div class="cta-bubble">
            <span>"Join our community today"</span>
          </div>
          <img src="/images/oddny-bird-pink.png" alt="Harrison" class="cta-bird" />
        </div>
      </div>
    </div>

    <!-- Similar Articles -->
    {similarBlogs.length > 0 && (
      <div class="similar-articles">
        <h2 class="similar-title">Similar Articles</h2>
        <div class="similar-grid">
          {similarBlogs.slice(0, 6).map((similar) => (
            <a href={`/${currentLocale}/blog/${similar.slug}`} class="similar-card">
              <div class="similar-image">
                {getImageUrl(similar.featured_image) ? (
                  <img src={getImageUrl(similar.featured_image)} alt={similar[`title_${currentLocale}`] || similar.title_nl} />
                ) : (
                  <div class="similar-placeholder"></div>
                )}
              </div>
              <div class="similar-info">
                <h3 class="similar-card-title">{similar[`title_${currentLocale}`] || similar.title_nl || 'Lorem ipsum dolor sit'}</h3>
                <p class="similar-card-excerpt">nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat...</p>
              </div>
            </a>
          ))}
        </div>
      </div>
    )}
  </article>
</Layout>

<style>
  .blog-article {
    width: 100%;
    max-width: 1440px;
    margin: 0 auto;
    background: white;
    font-family: 'Neue Haas Grotesk Display Pro', sans-serif;
  }

  .blog-hero {
    width: calc(100% - 160px);
    height: 636px;
    margin: 49px 81px 0;
    border-radius: 10px;
    overflow: hidden;
  }

  .blog-hero img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .blog-hero-placeholder {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
  }

  .blog-content-wrapper {
    display: grid;
    grid-template-columns: 220px 1fr;
    gap: 40px;
    padding: 60px 80px;
    align-items: start;
  }

  .blog-illustration {
    position: relative;
  }

  .harrison-img {
    width: 220px;
    height: 211px;
    object-fit: contain;
    transform: scaleY(-1) rotate(180deg);
  }

  .blog-header {
    max-width: 612px;
    margin-left: auto;
  }

  .blog-title {
    font-size: 80px;
    font-weight: 500;
    line-height: 85px;
    color: #42383e;
    margin: 0 0 40px;
  }

  .blog-intro {
    font-size: 28px;
    font-weight: 500;
    line-height: 30px;
    color: #888484;
    margin: 0;
  }

  .blog-author-section {
    display: flex;
    flex-direction: column;
    gap: 40px;
    padding: 40px 80px;
    margin: 0;
  }

  .author-row-1 {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .share-section {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .author-row-2 {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .author-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .author-card {
    background: #ff40b4;
    border-radius: 8px;
    padding: 16px 25px;
    display: flex;
    flex-direction: column;
    color: white;
    min-width: 160px;
  }

  .author-name {
    font-size: 22px;
    font-weight: 500;
    line-height: 26px;
  }

  .author-role {
    font-size: 16px;
    line-height: 22px;
  }

  .author-description {
    font-size: 22px;
    line-height: 30px;
    color: #888484;
    max-width: 405px;
    margin: 0;
  }

  .community-cta {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cta-bubble {
    background: #d9d9d9;
    border-radius: 4px;
    padding: 10px 20px;
    position: relative;
  }

  .cta-bubble::after {
    content: '';
    position: absolute;
    right: -12px;
    top: 50%;
    transform: translateY(-50%);
    border: 8px solid transparent;
    border-left-color: #d9d9d9;
  }

  .cta-bubble span {
    font-size: 16px;
    font-weight: 500;
    color: #42383e;
  }

  .cta-bird {
    width: 150px;
    height: 150px;
    object-fit: contain;
  }

  .all-articles-link {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #ff40b4;
    text-decoration: none;
    font-size: 18px;
    font-weight: 600;
  }

  .all-articles-link:hover {
    opacity: 0.8;
  }

  .share-label {
    font-size: 22px;
    font-weight: 500;
    color: #42383e;
  }

  .share-buttons {
    display: flex;
    gap: 8px;
  }

  .share-btn {
    width: 28px;
    height: 28px;
    background: #ff40b4;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-decoration: none;
  }

  .share-btn svg {
    width: 14px;
    height: 14px;
  }

  .share-btn:hover {
    opacity: 0.8;
  }

  .blog-main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 80px;
    padding: 120px 80px 60px;
  }

  .content-column {
    font-size: 22px;
    line-height: 30px;
    color: #888484;
  }

  .content-column :global(p) {
    margin-bottom: 20px;
  }

  .similar-articles {
    padding: 60px 80px;
    background: white;
  }

  .similar-title {
    font-size: 28px;
    font-weight: 500;
    line-height: 24px;
    color: #42383e;
    margin: 0 0 40px;
  }

  .similar-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 40px;
  }

  .similar-card {
    text-decoration: none;
    color: inherit;
  }

  .similar-image {
    width: 100%;
    height: 177px;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 12px;
  }

  .similar-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .similar-placeholder {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
  }

  .similar-card-title {
    font-size: 22px;
    font-weight: 500;
    line-height: 24px;
    color: #42383e;
    margin: 0 0 8px;
  }

  .similar-card-excerpt {
    font-size: 12px;
    line-height: 16px;
    color: #888484;
    margin: 0;
  }

  .similar-card:hover .similar-card-title {
    color: #ff40b4;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .blog-hero {
      margin: 30px 40px 0;
      width: calc(100% - 80px);
      height: 400px;
    }
    .blog-content-wrapper {
      padding: 40px;
      grid-template-columns: 1fr;
    }
    .blog-illustration {
      display: none;
    }
    .blog-title {
      font-size: 48px;
      line-height: 52px;
    }
    .blog-author-section {
      padding: 40px;
      gap: 30px;
    }
    .author-row-2 {
      flex-wrap: wrap;
      gap: 30px;
    }
    .community-cta {
      width: 100%;
      justify-content: flex-end;
    }
    .cta-bird {
      width: 120px;
      height: 120px;
    }
    .blog-main-content {
      grid-template-columns: 1fr;
      padding: 60px 40px;
    }
    .similar-grid {
      grid-template-columns: repeat(3, 1fr);
    }
    .similar-articles {
      padding: 40px;
    }
  }

  @media (max-width: 768px) {
    .blog-hero {
      margin: 20px;
      width: calc(100% - 40px);
      height: 300px;
    }
    .blog-content-wrapper {
      padding: 20px;
    }
    .blog-title {
      font-size: 32px;
      line-height: 38px;
    }
    .blog-intro {
      font-size: 18px;
      line-height: 24px;
    }
    .blog-author-section {
      padding: 30px 20px;
      gap: 24px;
    }
    .author-row-1 {
      flex-direction: column;
      gap: 20px;
    }
    .all-articles-link {
      align-self: flex-start;
    }
    .share-label {
      font-size: 18px;
    }
    .share-buttons {
      gap: 10px;
    }
    .share-btn {
      width: 32px;
      height: 32px;
    }
    .share-btn svg {
      width: 14px;
      height: 14px;
    }
    .author-row-2 {
      flex-direction: column;
      align-items: flex-start;
      gap: 24px;
    }
    .author-info {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }
    .author-description {
      font-size: 16px;
      line-height: 24px;
    }
    .community-cta {
      width: 100%;
      justify-content: space-between;
    }
    .cta-bubble::after {
      display: none;
    }
    .cta-bird {
      width: 100px;
      height: 100px;
    }
    .all-articles-link {
      font-size: 16px;
    }
    .blog-main-content {
      padding: 40px 20px;
    }
    .similar-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .similar-articles {
      padding: 20px;
    }
  }

  @media (max-width: 480px) {
    .share-buttons {
      flex-wrap: wrap;
    }
    .similar-grid {
      grid-template-columns: 1fr;
    }
  }

</style>

<script is:inline>
(function() {
  if (window.self !== window.top) {
    document.documentElement.classList.add('in-visual-editor');
  }
})();
</script>

<style is:global>
  .in-visual-editor [data-directus] {
    position: relative;
    transition: outline 0.15s ease;
  }
  .in-visual-editor [data-directus]:hover {
    outline: 2px solid #6644ff;
    outline-offset: 4px;
    cursor: pointer;
  }
</style>

<script is:inline define:vars={{ directusUrl, blogId: blog.id, currentLocale, otherLocale, slug }}>
(function() {
  var inIframe = window.self !== window.top;
  if (!inIframe) return;

  var DIRECTUS_URL = directusUrl;
  var BLOG_ID = blogId;
  var CURRENT_LOCALE = currentLocale;
  var accessToken = null;

  window.parent.postMessage({ type: 'directus:request-token' }, '*');

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'directus:token') {
      accessToken = event.data.token;
    }
  });

  document.querySelectorAll('[data-directus]').forEach(function(el) {
    el.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      var attr = el.getAttribute('data-directus');
      var parts = {};
      attr.split(';').forEach(function(part) {
        var kv = part.split(':');
        if (kv.length >= 2) parts[kv[0]] = kv.slice(1).join(':');
      });

      if (parts.mode === 'drawer') {
        window.open(DIRECTUS_URL + '/admin/content/' + parts.collection + '/' + parts.item, '_blank');
        return;
      }

      if (!parts.fields) return;
      var field = parts.fields.split(',')[0];
      showEditPopup(el, parts.collection, parts.item, field);
    });
  });

  function showEditPopup(targetEl, collection, itemId, field) {
    var existing = document.querySelector('.inline-edit-popup');
    if (existing) existing.remove();

    var currentValue = targetEl.textContent.trim();
    var isTextarea = field.includes('intro') || field.includes('content');

    var popup = document.createElement('div');
    popup.className = 'inline-edit-popup';
    popup.style.cssText = 'position:fixed;background:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:10000;min-width:320px;max-width:450px;font-family:Inter,system-ui,sans-serif;';
    popup.innerHTML =
      '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;background:#f9fafb;border-radius:12px 12px 0 0;">' +
        '<h3 style="margin:0;font-size:14px;font-weight:600;color:#374151;">Edit ' + field + '</h3>' +
        '<button class="close-btn" style="background:none;border:none;font-size:20px;cursor:pointer;color:#9ca3af;">&times;</button>' +
      '</div>' +
      '<div style="padding:16px;">' +
        (isTextarea
          ? '<textarea class="edit-input" style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;min-height:150px;resize:vertical;">' + currentValue + '</textarea>'
          : '<input type="text" class="edit-input" value="' + currentValue.replace(/"/g, '&quot;') + '" style="width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">') +
      '</div>' +
      '<div style="display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #e5e7eb;">' +
        '<button class="cancel-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:white;border:1px solid #d1d5db;color:#374151;">Cancel</button>' +
        '<button class="save-btn" style="padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;background:#6644ff;border:none;color:white;">Save</button>' +
      '</div>';

    var rect = targetEl.getBoundingClientRect();
    popup.style.top = Math.min(rect.bottom + 10, window.innerHeight - 300) + 'px';
    popup.style.left = Math.max(10, Math.min(rect.left, window.innerWidth - 350)) + 'px';

    document.body.appendChild(popup);

    var input = popup.querySelector('.edit-input');
    input.focus();

    popup.querySelector('.close-btn').onclick = function() { popup.remove(); };
    popup.querySelector('.cancel-btn').onclick = function() { popup.remove(); };

    popup.querySelector('.save-btn').onclick = async function() {
      var newValue = input.value;
      try {
        var response = await fetch(DIRECTUS_URL + '/items/' + collection + '/' + itemId, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + accessToken
          },
          body: JSON.stringify({ [field]: newValue })
        });

        if (response.ok) {
          if (targetEl.innerHTML !== undefined && isTextarea) {
            targetEl.innerHTML = newValue;
          } else {
            targetEl.textContent = newValue;
          }
          popup.remove();
          window.parent.postMessage({ type: 'directus:content-updated' }, '*');
        } else {
          alert('Error saving');
        }
      } catch (err) {
        alert('Error saving');
      }
    };
  }
})();
</script>
